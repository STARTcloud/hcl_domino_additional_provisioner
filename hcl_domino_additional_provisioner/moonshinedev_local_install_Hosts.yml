#jinja2:lstrip_blocks: True
# core_provisioner_version: {{ core_provisioner_version }}
# provisioner_name: {{ provisioner_name }}
# provisioner_version: {{ provisioner_version }}
---
hosts:
  -
    settings:
      debug_build: true
      hostname: moonshinedev
      domain: m4kr.net
      server_id: '4020'
      vcpus: 4
      memory: 16G
      box: 'STARTcloud/debian12-server'
      box_url: 'https://vagrantcloud.com'
      box_version: 0.0.8
      os_type: 'Debian_64'
      provider-type: virtualbox
      firmware_type: UEFI
      consoleport: 4020
      consolehost: 0.0.0.0
      setup_wait: 300
      vagrant_user_private_key_path: ./id_rsa
      vagrant_user: startcloud
      vagrant_user_pass: 'XaVuzq2vRV4fTk'
      vagrant_insert_key: true
      ssh_forward_agent: true
      show_console: false

    zones:
      vmtype: production
      brand: bhyve
      on_demand_vnics: 'true'
      post_provision_boot: false
      console_onboot: false
      console: webvnc
      debug: false
      debug_boot: false
      hostbridge: i440fx
      acpi: on
      autostart: true
      setup_method: zlogin
      diskif: virtio
      netif: virtio-net-viona
      booted_string: 'Web console:'
      lcheck_string: ':~$'
      alcheck_string: 'login:'
      safe_restart: 'sudo shutdown -r'
      safe_shutdown: 'sudo init 0 || true'
      clean_shutdown_time: 200
      snapshot_script: '/opt/vagrant/bin/Snapshooter.sh'
      cpu_configuration: simple

    plugins:
      - vagrant-scp

    networks:
      -
        type: external
        address: #192.168.255.255
        netmask: #255.255.255.0
        gateway: #192.168.2.1
        autoconf: false 
        vlan:
        dhcp4: true
        dhcp6: false
        is_control: false
        route: default
        provisional: false
        bridge:
        nic_type: virtio
        mac: auto
        dns:
          - nameserver: 199.103.5.20
          - nameserver: 199.103.7.51

    disks:
      boot:
        array: Array-1
        dataset: zones
        volume_name: boot
        mount: /
        size: 48G
    
#      additional_disks:
#        - array: Array-1
#          dataset: zones
#          sparse: true
#          live: false
#          filesystem: xfs
#          mount: /local
#          size: 50.0G
#          port: 5
#          volume_name: disk1

    provisioning:
      ansible:
        enabled: true
        playbooks:
          - local:
              -
                description: "This generates a Ansible Playbook on the VM with all the variables in Hosts.yml"
                playbook: ansible/generate-playbook.yml
                ansible_python_interpreter: /usr/bin/python3
                compatibility_mode: 2.0
                install_mode: pip
                ssh_pipelining: true
                verbose: false
                callbacks: profile_tasks
                run: always
                remote_collections: false
                collections: []
              -
                description: "This generates and runs the previously generated playbook, This playbook configures the machine"
                playbook: ansible/playbook.yml
                ansible_python_interpreter: /usr/bin/python3
                compatibility_mode: 2.0
                install_mode: pip
                ssh_pipelining: true
                verbose: false
                callbacks: profile_tasks
                run: once
                remote_collections: false
                collections:
                  - startcloud.startcloud_roles
                  - startcloud.hcl_roles
                  - moonshine.moonshine_roles
              -
                description: "This Playbook is a special provisioner that will always run, ie vagrant up, vagrant reload"
                playbook: ansible/always-playbook.yml
                ansible_python_interpreter: /usr/bin/python3
                compatibility_mode: 2.0
                install_mode: pip
                ssh_pipelining: true
                verbose: false
                callbacks: profile_tasks
                run: not_first
                remote_collections: false
                collections:
                  - startcloud.startcloud_roles

    folders:
      -
        description: "Disables VBoxSF, do not enable"
        map: .
        to: /vagrant
        type: virtualbox
        disabled: true
        automount: true
      -
        description: "Directory for Ansible Scripts"
        map: ./provisioners/ansible
        to: /vagrant/ansible
        type: rsync
        args:
          - '--verbose'
          - '--archive'
          - '--delete'
          - '-z'
          - '--copy-links'
      -
        description: "Directory for Application Installers"
        map: ./installers
        to: /vagrant/installers
        type: rsync
      -
        description: "Directory for Pre-Signed SSLs"
        map: ./ssls
        to: /secure
        type: rsync
      -
        description: "Directory for Server and User IDs"
        map: ./id-files
        to: /id-files
        type: rsync
        syncback: true

    vars:
      debug_all: true
      selfsigned_enabled: true
      haproxy_ssl_redirect: true

      # Hosts entries for /etc/hosts
      #etc_hosts_entries:
      #  - hostname: dominolearn-1.trainingwheels.lol
      #    aliases:
      #      - dominolearn1
      #    ip: 172.16.204.137
      #  - hostname: dominolearn-2.trainingwheels.lol
      #    aliases:
      #      - dominolearn2
      #    ip: 172.16.204.138

    roles:
      - name: startcloud.startcloud_roles.setup
      - name: startcloud.startcloud_roles.networking
        tags: always
      - name: startcloud.startcloud_roles.disks
      - name: startcloud.startcloud_roles.hostname
      - name: startcloud.startcloud_roles.dependencies
      - name: startcloud.startcloud_roles.mdns
      - name: startcloud.startcloud_roles.service_user
      - name: startcloud.startcloud_roles.sdkman_install
      - name: startcloud.startcloud_roles.sdkman_java
      - name: startcloud.startcloud_roles.sdkman_maven
      - name: startcloud.startcloud_roles.sdkman_gradle
      - name: startcloud.startcloud_roles.ssl
      - name: startcloud.hcl_roles.domino_vagrant_rest_api
      - name: startcloud.startcloud_roles.haxe
      - name: moonshine.moonshine_roles.moonshinedev_deploy
      - name: startcloud.startcloud_roles.haproxy
        vars:
          haproxy_cfg: /vagrant/ansible/ansible_collections/moonshine/moonshine_roles/roles/moonshinedev_deploy/templates/moonshinedev-haproxy.cfg.j2
#      - name: startcloud.startcloud_roles.lockdown

     #- name: startcloud.hcl_roles.domino_reset
#      - name: startcloud.hcl_roles.domino_install
#      - name: startcloud.hcl_roles.domino_vagrant_rest_api
#      - name: startcloud.hcl_roles.domino_service_nash
#      - name: startcloud.hcl_roles.domino_java_config
#      - name: startcloud.hcl_roles.domino_java_tools
#      - name: startcloud.hcl_roles.domino_updatesite
#      - name: startcloud.hcl_roles.domino_config 
#      - name: startcloud.hcl_roles.domino_genesis
#      - name: startcloud.hcl_roles.domino_genesis_applications
#      - name: startcloud.hcl_roles.domino_cross_certify
#      - name: startcloud.hcl_roles.domino_java_app_example
      #- name: startcloud.hcl_roles.domino_leap
      #- name: startcloud.hcl_roles.domino_traveler
      #- name: startcloud.hcl_roles.domino_traveler_htmo
      #- name: startcloud.hcl_roles.domino_verse
      #- name: startcloud.hcl_roles.domino_appdevpack
      #- name: startcloud.hcl_roles.domino_rest_api
#      - name: startcloud.hcl_roles.domino_nomadweb
#      - name: startcloud.hcl_roles.domino_vagrant_readme
#      - name: startcloud.startcloud_roles.vagrant_readme
#      - name: startcloud.startcloud_roles.quick_start
#        tags: always
#      - name: startcloud.startcloud_roles.haproxy
